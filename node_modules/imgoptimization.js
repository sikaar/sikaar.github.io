// npm install --save superagent
// npm install image-size --save

const sizeOf = require('image-size');
const request = require('superagent');
const fs = require('fs');


var folderList=['./textures/','./panels/','./slidedeck/'];
var resolution=['256','512','1024','2048','4096'];
var APIkey = YOUR_API_KEY; // create a free account on https://imageoptim.com/api

folderList.forEach(testFolder =>{

		//var testFolder = folderList[i];
		console.log('************************************* ' + testFolder + '    ************************************');

		fs.readdir(testFolder, (err, files) => {
			files.forEach(filename => {

				var dimensions = sizeOf(testFolder + filename);
				console.log( "real dimensions " + dimensions.width +" x " + dimensions.height);


				var optionWidth = closest(dimensions.width,resolution);
				var optionHeight = closest(dimensions.height,resolution); 
				console.log( "optim dimensions " + optionWidth +" x " + optionHeight);

				request.post('https://im2.io/' + APIkey + '/' + optionWidth +"x" + optionHeight + ',stretch')
				.attach('file', testFolder + filename)
				.end(function(err, result){
				fs.writeFile(testFolder + filename, result.body);
				});

			});
		});

});

function closest(needle, haystack) {
    return haystack.reduce((a, b) => {
        let aDiff = Math.abs(a - needle);
        let bDiff = Math.abs(b - needle);

        if (aDiff == bDiff) {
            return a > b ? a : b;
        } else {
            return bDiff < aDiff ? b : a;
        }
    });
}






